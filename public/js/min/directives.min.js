(function(){"use strict";angular.module("Museum.directives",[]).directive("ngBlur",function(){return function(e,t,n){return t.bind("blur",function(){return e.$apply(n.ngBlur)})}}).directive("ngFocus",function(e){return function(t,n,i){return t.$watch(i.ngFocus,function(t){return t?e(function(){return n[0].focus()},0,!1):void 0})}}).directive("focusMe",function(e,t){return{link:function(n,i,r){var a;return a=t(r.focusMe),n.$watch(a,function(t){return t===!0?e(function(){return i[0].focus()}):void 0}),i.bind("blur",function(){return n.$apply(a.assign(n,!1))})}}}).directive("stopEvent",function(){return{link:function(e,t,n){return t.bind(n.stopEvent,function(e){return e.stopPropagation()})}}}).directive("resizer",function(){return{restrict:"A",link:function(e,t){var n;return n=$(t),n.focus(function(){return n.animate({width:"+=150"},200)}),n.blur(function(){return n.animate({width:"-=150"},200)})}}}).directive("toggleMenu",function(){return{restrict:"A",link:function(e,t){var n;return n=$(t),n.click(function(){return $(".museum_navigation_menu").slideToggle(300),setTimeout(function(){return $.scrollTo(0,0)},0)})}}}).directive("toggleFilters",function(){return{restrict:"A",link:function(e,t){var n;return n=$(t),n.click(function(){var t,n,i;return t=$(".filters_bar"),i=$(".filters_placeholder"),n=t.css("top"),"0px"===n?(t.animate({top:"-44px"},300),i.animate({height:"0px"},300)):(t.animate({top:"0px"},300),i.animate({height:"44px"},300)),e.filters_opened=!e.filters_opened})}}}).directive("postRender",function(e){return{restrict:"A",link:function(t){var n;return t.$last&&(e(t.grid,200),n={target:$(".museum_edit_opener")},$("ul.exhibits.common").scrollspy({min:50,max:99999,onEnter:function(){return $(".float_menu").addClass("navbar-fixed-top"),$(".navigation").addClass("bottom-padding"),$(".to_top").show()},onLeave:function(){return $(".float_menu").removeClass("navbar-fixed-top"),$(".navigation").removeClass("bottom-padding"),$(".to_top").hasClass("has_position")?void 0:$(".to_top").hide()},onTick:function(){return t.museum_edit_dropdown_opened?t.show_museum_edit(n):void 0}})),!0}}}).directive("switchpubitem",function(){return{restrict:"E",replace:!0,transclude:!0,require:"?ngModel",scope:{item:"=ngItem",provider:"=ngProvider",current_museum:"=ngMuseum",trans:"=translations",field:"@field",field_type:"@type",root:"=root"},template:'<div class="btn-group pull-right item_publish_settings" ng-hide="item.status == \'draft\'">\n  <button class="btn btn-default dropdown-toggle" ng-class="{\'btn-success\': item.status == \'published\', \'btn-warning\': item.status == \'passcode\', \'btn-danger\': item.status == \'opas_invisible\'}" ng-switch on="item[field]">\n    <div class="extra" ng-switch ng-switch on="item[field]">\n      <i ng-switch-when="published" class="icon-globe"></i>\n      <i ng-switch-when="passcode" class="icon-lock"></i>\n      <i ng-switch-when="opas_invisible" class="icon-eye-close"></i>\n    </div>\n    <!-- span ng-switch-default>{{ \'Publish\' | i18next }}</span> -->\n    <span ng-switch-when="published">{{ \'Published\' | i18next }}</span>\n    <span ng-switch-when="passcode">{{ \'Private\' | i18next }}</span>\n    <span ng-switch-when="opas_invisible">{{ \'Invisible\' | i18next }}</span>\n    <span>\n      &nbsp;<i class="icon-caret-down"></i>\n    </span>\n  </button>\n\n\n  <!-- <button class="btn btn-default" ng-hide="item.status == \'opas_invisible\'" ng-class="{\'active btn-warning\': item.status == \'passcode\' }" ng-click="item.status = \'passcode\'; status_process()" type="button" ng-switch on="item[field]">\n    <div class="extra">\n      <i class="icon-lock"></i>\n    </div>\n    <span ng-switch-when="passcode">{{ \'Private\' | i18next }}</span>\n    <span ng-switch-when="published">{{ \'Make private\' | i18next }}</span>\n  </button>\n\n\n  <button class="btn btn-default" ng-show="item.status == \'opas_invisible\'" ng-class="{\'active btn-danger\': item.status == \'opas_invisible\' }" ng-click="item.status = \'opas_invisible\'; status_process()" type="button">\n    <div class="extra">\n      <i class="icon-eye-close"></i>\n    </div>\n    <span>{{ \'Invisible\' | i18next }}</span>\n  </button> -->\n\n\n  <!-- <button class="btn btn-default dropdown-toggle">\n    <span>\n      <i class="icon-caret-down"></i>\n    </span>\n  </button> -->\n  <ul class="dropdown-menu">\n    <li ng-hide="item.status == \'published\'">\n      <a href="#" ng-click="item.status = \'published\'; status_process()">\n        <i class="icon-globe"></i> &nbsp;{{ \'Publish\' | i18next }}\n      </a>\n    </li>\n    <li ng-hide="item.status == \'passcode\'">\n      <a href="#" ng-click="item.status = \'passcode\'; status_process()">\n        <i class="icon-lock"></i> &nbsp;&nbsp;{{ \'Make private\' | i18next }}\n      </a>\n    </li>\n    <li ng-hide="item.status == \'opas_invisible\'">\n      <a href="#" ng-click="item.status = \'opas_invisible\'; status_process()">\n        <i class="icon-eye-close"></i> {{ \'Make invisible\' | i18next }}\n      </a>\n    </li>\n  </ul>\n</div>',controller:function(e,t,n,i,r){return e.status_process=function(){if(e.$parent.grouped_exhibits){switch(e.item.status){case"published":e.$parent.grouped_positions.published=!1;break;case"passcode":e.$parent.grouped_positions.passcode=!1;break;case"opas_invisible":e.$parent.grouped_positions.invisible=!1}setTimeout(function(){return e.$parent.grid()},200),e.$parent.active_exhibit.reopen_dropdown=!0,e.$parent.closeDropDown(),setTimeout(function(){var t;return t=$("li.exhibit.reopen > .opener"),e.$parent.open_dropdown({target:t},e.$parent.active_exhibit),e.$parent.active_exhibit.reopen_dropdown=!1},500)}return r.checkValidity(e)}},link:function(e){return e.hidden_list=!0,!0}}}).directive("switchpub",function(){return{restrict:"E",replace:!0,transclude:!0,require:"?ngModel",scope:{item:"=ngItem",provider:"=ngProvider",field:"@field",field_type:"@type",root:"=root"},template:'<div class="btn-group pull-right">\n  <button class="btn btn-default" type="button">\n    <div ng-switch on="item[field]">\n      <i class="icon-globe" ng-switch-when="published" ng-click="item[field] = \'passcode\'; status_process()" ></i>\n      <i class="icon-lock" ng-switch-when="passcode" ng-click="item[field] = \'published\'; status_process()" ></i>\n      <i class="icon-eye-close" ng-switch-when="opas_invisible" ng-click="item[field] = \'published\'; status_process()" ></i>\n    </div>\n  </button>\n</div>',controller:function(e,t,n,i,r){return e.status_process=function(){return r.checkValidity(e)}},link:function(){return!0}}}).directive("newLangSwitch",function(){return{restrict:"E",replace:!0,scope:{museum:"=museum"},template:'<div class="form-group">\n  <label class="col-xs-2 control-label" for="museum_language_select">{{ \'Language\' | i18next }}</label>\n  <div class="help ng-scope" popover="{{ \'Select language\' | i18next }}" popover-animation="true" popover-placement="bottom" popover-trigger="mouseenter">\n    <i class="icon-question-sign"></i>\n  </div>\n  <div class="col-xs-6 triggered">\n    <select class="form-control" ng-model="museum.language">\n      <option disabled="" selected="" value="dummy">{{ \'Select a new language\' | i18next }}</option>\n      <option value="{{translation}}" ng-repeat="(translation, lang) in $parent.$parent.translations">{{translation | i18next }}</option>\n    </select>\n </div>\n</div>',controller:function(){return!0},link:function(e){return e.$watch("museum.language",function(e){return null!=e&&"new_lang"!==e?console.log("select",e):void 0}),!0}}}).directive("placeholderfield",function(e){return{restrict:"E",replace:!0,require:"?ngModel",scope:{item:"=ngItem",help:"@ngHelp",id:"@ngId",title:"@ngTitle",field:"@ngField",inv_sign:"=invalidsign",placeholder:"=placeholder",field_type:"@type"},template:'<div class="form-group textfield {{field}}">\n  <label class="col-xs-2 control-label" for="{{id}}" ng-click="edit_mode = false">\n    {{title}}\n    <span class="label label-danger informer" ng-show="empty_name_error">{{ "can\'t be empty" | i18next }}</span>\n  </label>\n  <div class="help" popover="{{help}}" popover-placement="bottom" popover-animation="true" popover-trigger="mouseenter">\n    <i class="icon-question-sign"></i>\n  </div>\n  {{active_exhibit}}\n  <div class="col-xs-7 trigger">\n    <span class="placeholder" ng-click="update_old()">{{item[field]}}</span>\n  </div>\n  <div class="col-xs-7 triggered">\n    <input type="hidden" id="original_{{id}}" ng-model="item[field]" required>\n    <input type="text" class="form-control" id="{{id}}" value="{{item[field]}}" placeholder="{{placeholder}}">\n    <div class="additional_controls">\n      <a href="#" class="apply"><i class="icon-ok"></i></a>\n      <!--<a href="#" class="cancel"><i class="icon-remove"></i></a>-->\n    </div>\n  </div>\n  <status-indicator ng-binding="status"></statusIndicator>\n</div>',controller:function(e,t){return null==e.item.statuses&&(e.item.statuses={}),e.status=e.item.statuses[e.item.field],e.update_old=function(){return e.oldValue=e.item[e.field]},e.status_process=function(){return e.item[e.field]!==e.oldValue?(e.status="progress",e.$digest(),e.$parent.new_item_creation&&"name"===e.field&&e.item[e.field]&&0!==e.item[e.field].length?(t.$broadcast("save_new_exhibit"),!0):("name"===e.field&&"draft"===e.item.status&&(e.item.status="passcode"),t.$broadcast("changes_to_save",e))):void 0}},link:function(t,n){var i,r,a,s;return n=$(n),a=n.find(".trigger"),s=n.find(".triggered"),r=n.find(".triggered > .form-control"),i=s.find(".additional_controls"),t.empty_name_error=!1,n.find("span.placeholder").click(function(){return a.hide(),s.show(),r.val(t.item[t.field]),r.focus(),r.removeClass("ng-invalid")}),n.find(".triggered > .form-control").focus(function(){return i.show()}),n.find(".triggered > .form-control").blur(function(){var n,r;return n=$(this),r=n.val(),i.hide(),e(function(){if(!t.$parent.new_item_creation||"number"!==t.field){if(t.item[t.field]=r,t.$digest(),!(n.val().length>0))return!0;t.status_process()}return n.val().length>0?(s.hide(),a.show()):(n.addClass("ng-invalid"),"name"===t.field&&"dummy"!==t.item.status&&(n.val(t.oldValue),t.item[t.field]=t.oldValue,t.$digest(),s.hide(),a.show(),""!==t.item[t.field])?t.status_process():void 0)},100)}),n.find(".triggered > .form-control").keyup(function(){var n,i;return n=$(this),i=n.val(),""===i&&"name"===t.field&&""!==t.item[t.field]&&e(function(){return n.val(t.oldValue),t.item[t.field]=t.oldValue,t.empty_name_error=!0,t.$digest(),setTimeout(function(){return t.empty_name_error=!1,t.$digest()},2e3),t.status_process()},0,!1),!0}),t.$watch("item[field]",function(e){var o;return t.status="",o="number"===t.field?null!=e:e,o?(i.show(),n.find(".triggered > .form-control").val(e),a.show(),s.hide()):(i.hide(),a.hide(),s.show(),r.val(""),"name"===t.field?s.find(".form-control").focus():void 0)}),!0}}}).directive("placeholdertextarea",function(e,t,n){return{restrict:"E",replace:!0,require:"?ngModel",scope:{item:"=ngItem",help:"@ngHelp",id:"@ngId",title:"@ngTitle",field:"@ngField",max_length:"@maxlength",placeholder:"=placeholder",field_type:"@type"},template:'<div class="form-group textfield large_field">\n  <label class="col-xs-2 control-label" for="{{id}}" ng-click="edit_mode = false">\n    {{title}}\n    <span class="label label-danger" ng-show="field == \'long_description\' && item[field].length == 0">{{ "Fill to publish" | i18next }}</span>\n  </label>\n  <div class="help" popover="{{help}}" popover-placement="bottom" popover-animation="true" popover-trigger="mouseenter">\n    <i class="icon-question-sign"></i>\n  </div>\n  <div class="col-xs-7 trigger">\n    <div class="placeholder large" ng-click="update_old()">{{item[field]}}</div>\n  </div>\n  <div class="col-xs-7 triggered">\n    <input type="hidden" id="original_{{id}}" ng-model="item[field]" required">\n    <div class="content_editable" contenteditable="true" id="{{id}}" placeholder="{{placeholder}}">{{item[field]}}</div>\n    <div class="additional_controls">\n      <a href="#" class="apply"><i class="icon-ok"></i></a>\n      <!--<a href="#" class="cancel"><i class="icon-remove"></i></a>-->\n    </div>\n  </div>\n  <span class="sumbols_left">\n    {{length_text}}\n  </span>\n  <status-indicator ng-binding="status"></statusIndicator>\n</div>',controller:function(e,t){return null==e.item.statuses&&(e.item.statuses={}),e.status=e.item.statuses[e.item.field],e.update_old=function(){return e.oldValue=e.item[e.field]},e.status_process=function(){return e.item[e.field]!==e.oldValue?(e.status="progress",e.$digest(),t.$broadcast("changes_to_save",e)):void 0}},link:function(e,i){var r,a,s,o,l;return e.length_text=""+e.max_length+" symbols left",e.max_length||(e.max_length=2e3),i=$(i),o=i.find(".trigger"),l=i.find(".triggered"),s=i.find(".sumbols_left"),a=l.children(".content_editable"),r=l.find(".additional_controls"),i.find("div.placeholder").click(function(){return o.hide(),l.show(),a.text(e.item[e.field]),a.focus(),e.length_text=""+(e.max_length-a.text().length)+" "+n("symbols left"),s.show()}),a.focus(function(){return s.show(),r.show()}),a.blur(function(){var t;return t=$(this),s.hide(),e.item[e.field]=t.text(),e.$digest(),e.status_process(),""!==t.text()?(l.hide(),o.show(),e.status_process()):r.hide()}),a.keyup(function(){var t,i;return t=$(this),i=t.text(),i.length>e.max_length&&t.text(i.substr(0,e.max_length)),e.length_text=""+(e.max_length-i.length)+" "+n("symbols left"),e.$digest()}),e.$watch("item[field]",function(i){return e.max_length||(e.max_length=2e3),i?(r.show(),e.length_text=""+(e.max_length-i.length)+" "+n("symbols left"),e.$parent.element_switch===!0&&(o.show(),l.hide(),s.hide()),!0):(e.length_text="2000 "+n("symbols left"),a.text(""),o.hide(),l.show(),r.hide(),"long_description"===e.field?t.checkValidity({item:e.item,root:e.$parent.active_exhibit,field_type:"story"}):void 0)}),!0}}}).directive("quizanswer",function(){return{restrict:"E",replace:!0,require:"?ngModel",scope:{item:"=ngItem",collection:"=ngCollection",id:"@ngId",field:"@field",field_type:"@type"},template:'<div class="form-group textfield string optional checkbox_added">\n  <label class="string optional control-label col-xs-2" for="{{id}}">\n    <span class=\'correct_answer_indicator\'>{{ "correct" | i18next }}</span>\n  </label>\n  <input class="coorect_answer_radio" name="correct_answer" type="radio" value="{{item._id}}" ng-model="checked" ng-click="check_items(item)">\n  <div class="col-xs-5 trigger">\n    <span class="placeholder" ng-click="update_old()">{{item[field]}}</span>\n  </div>\n  <div class="col-xs-5 triggered">\n    <input class="form-control" id="{{id}}" name="{{item._id}}" placeholder="Enter option" type="text" ng-model="item[field]" required>\n    <div class="error_text">{{ "can\'t be blank" | i18next }}</div>\n  </div>\n  <status-indicator ng-binding="status"></statusIndicator>\n</div>',controller:function(e,t){return null==e.item.statuses&&(e.item.statuses={}),e.status=e.item.statuses[e.item.content],null==e.item.correct_saved&&(e.item.correct_saved=!1),e.check_items=function(n){return t.$broadcast("quiz_changes_to_save",e,n)},e.update_old=function(){return e.oldValue=e.item[e.field]},e.status_process=function(){return e.item[e.field]!==e.oldValue?(e.status="progress",e.$digest(),t.$broadcast("changes_to_save",e)):void 0}},link:function(e,t){var n,i,r;return t=$(t),i=t.find(".trigger"),r=t.find(".triggered"),n=t.find(".correct_answer_indicator"),t.find("span.placeholder").click(function(){return i.hide(),r.show().children().first().focus()}),t.find(".triggered > *").blur(function(){var t;return t=$(this),e.status_process(),""!==t.val()?(r.hide(),i.show()):void 0}),e.$watch("collection",function(t){var n,i,r,a;if(t){for(e.checked=t[0]._id,a=[],i=0,r=t.length;r>i;i++)n=t[i],n.correct===!0?a.push(e.checked=n._id):a.push(void 0);return a}}),e.$watch("item.content",function(t){return t?e.$parent.element_switch===!0?(i.show(),r.hide()):void 0:(i.hide(),r.show())}),e.$watch("item.correct_saved",function(t){return t===!0?(n.show(),setTimeout(function(){return n.hide(),e.$apply(e.item.correct_saved=!1)},1e3)):void 0},!0)}}}).directive("statusIndicator",function(){return{restrict:"E",replace:!0,require:"?ngModel",scope:{item:"=ngBinding",field:"=ngField"},template:'<div class="statuses">\n  <div class=\'preloader\' ng-show="item==\'progress\'"></div>\n  <div class="save_status" ng-show="item==\'done\'">\n    <i class="icon-ok-sign"></i>{{ "saved" | i18next }}\n  </div>\n</div>',link:function(e){return e.$watch("item",function(t){return t?("progress"===t&&(e.progress_timeout=setTimeout(function(){return e.$apply(e.item="done")},500)),"done"===t?e.done_timeout=setTimeout(function(){return e.$apply(e.item="")},700):void 0):(clearTimeout(e.done_timeout),clearTimeout(e.progress_timeout))},!0),!0}}}).directive("audioplayer",function(){return{restrict:"E",replace:!0,require:"?ngModel",scope:{item:"=ngItem",help:"@ngHelp",id:"@ngId",title:"@ngTitle",field:"@ngField",parent:"=parent"},template:'<div class="form-group audio">\n  <label class="col-xs-2 control-label" for="audio">\n    {{ "Audio" | i18next }}\n    <span class="label label-danger" ng-show="edit_mode == \'empty\'">{{ "Fill to publish" | i18next }}</span>\n  </label>\n  <div class="help">\n    <i class="icon-question-sign" data-content="{{ "Supplementary field." | i18next }}" data-placement="bottom"></i>\n  </div>\n  <div class="col-xs-9 trigger" ng-show="edit_mode == \'value\'">\n    <div class="jp-jplayer" id="jquery_jplayer_{{id}}">\n    </div>\n    <div class="jp-audio" id="jp_container_{{id}}">\n      <div class="jp-type-single">\n        <div class="jp-gui jp-interface">\n          <ul class="jp-controls">\n            <li>\n            <a class="jp-play" href="javascript:;" tabindex="1"></a>\n            </li>\n            <li>\n            <a class="jp-pause" href="javascript:;" tabindex="1"></a>\n            </li>\n          </ul>\n        </div>\n        <div class="jp-timeline">\n          <div class="dropdown">\n            <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="visibility_filter">{{item[field].name}}<span class="caret"></span></a>\n            <ul class="dropdown-menu" role="menu">\n              <li role="presentation">\n                <a href="#" class="replace_media" data-confirm="Are you sure you wish to replace this audio?" data-method="delete" data-link="{{$parent.$parent.backend_url}}/media/{{item[field]._id}}">Replace</a>\n              </li>\n              <li role="presentation">\n                <a href="{{item[field].url}}" target="_blank">Download</a>\n              </li>\n              <li role="presentation">\n                <a class="remove" href="#" data-confirm="Are you sure you wish to delete this audio?" data-method="delete" data-link="{{$parent.$parent.backend_url}}/media/{{media._id}}" delete-media="" stop-event="" media="item[field]" parent="item">Delete</a>\n              </li>\n            </ul>\n          </div>\n          <div class="jp-progress">\n            <div class="jp-seek-bar">\n              <div class="jp-play-bar">\n              </div>\n            </div>\n          </div>\n          <div class="jp-time-holder">\n            <div class="jp-current-time">\n            </div>\n            <div class="jp-duration">\n            </div>\n          </div>\n          <div class="jp-no-solution">\n            <span>Update Required</span>To play the media you will need to either update your browser to a recent version or update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank"></a>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="triggered" ng-show="edit_mode == \'empty\'">\n    <img class="upload_audio" src="/img/audio_drag.png" />\n    <span>drag audio here or </span>\n    <a href="#" class="btn btn-default" button-file-upload="">Click to upload</a>\n  </div>\n  <div class="col-xs-9 processing" ng-show="edit_mode == \'processing\'">\n    <img class="upload_audio" src="/img/medium_loader.GIF" style="float: left;"/> \n    <span>{{ "&nbsp;&nbsp;processing audio" | i18next }}</span>\n  </div>\n  <status-indicator ng-binding="item" ng-field="field"></statusIndicator>\n</div>',link:function(e,t){return e.edit_mode=!1,t=$(t),t.find(".replace_media").click(function(e){var t,n,i;return e.preventDefault(),e.stopPropagation(),t=$(this),i=t.parents("#drop_down, #museum_drop_down"),i.click(),n=i.find("input:file"),n.click()}),e.$watch("item[field]",function(t){return t?"processing"===t?e.edit_mode="processing":(e.edit_mode="value",$("#jquery_jplayer_"+e.id).jPlayer({cssSelectorAncestor:"#jp_container_"+e.id,swfPath:"/js",wmode:"window",preload:"auto",smoothPlayBar:!0,supplied:"mp3, ogg"}),$("#jquery_jplayer_"+e.id).jPlayer("setMedia",{mp3:t.url,ogg:t.thumbnailUrl})):e.edit_mode="empty"}),!0}}}).directive("player",function(){return{restrict:"E",replace:!0,require:"?ngModel",scope:{item:"=ngItem",help:"@ngHelp",id:"@ngId",title:"@ngTitle",field:"@ngField",container:"=container"},template:'<div class="player">\n  <div class="jp-jplayer" id="jquery_jplayer_{{id}}">\n  </div>\n  <div class="jp-audio" id="jp_container_{{id}}">\n    <div class="jp-type-single">\n      <div class="jp-gui jp-interface">\n        <ul class="jp-controls">\n          <li>\n          <a class="jp-play" href="javascript:;" tabindex="1"></a>\n          </li>\n          <li>\n          <a class="jp-pause" href="javascript:;" tabindex="1"></a>\n          </li>\n        </ul>\n      </div>\n      <div class="jp-timeline">\n        <a class="dropdown-toggle" href="#">&nbsp;</a>\n        <div class="jp-progress">\n          <div class="jp-seek-bar">\n            <div class="jp-play-bar">\n            </div>\n          </div>\n        </div>\n        <div class="jp-time-holder">\n          <div class="jp-current-time">\n          </div>\n          <div class="jp-duration">\n          </div>\n        </div>\n        <div class="jp-no-solution">\n          <span>Update Required</span>To play the media you will need to either update your browser to a recent version or update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank"></a>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="points_position_holder">\n    <div class="image_connection" ng-class="{\'hovered\': image.image.hovered}" data-image-index="{{$index}}" js-draggable ng-repeat="image in container.stories[$parent.current_museum.language].mapped_images" ng-mouseenter="set_hover(image, true)" ng-mouseout="set_hover(image, false)">\n      {{ charFromNum(image.image.order) }}\n    </div>\n  </div>\n</div>',controller:function(e){return e.charFromNum=function(e){return String.fromCharCode(e+97).toUpperCase()},e.set_hover=function(t,n){var i;return i=n?n:t.dragging?!0:n,t.image.hovered=i,e.container.has_hovered=i}},link:function(e){return e.$watch("item[field]",function(t){return t?($("#jquery_jplayer_"+e.id).jPlayer({cssSelectorAncestor:"#jp_container_"+e.id,swfPath:"/js",wmode:"window",preload:"auto",smoothPlayBar:!0,supplied:"mp3, ogg"}),$("#jquery_jplayer_"+e.id).jPlayer("setMedia",{mp3:t.url,ogg:t.thumbnailUrl})):console.log("no audio")}),!0}}}).directive("museumSearch",function(){return{restrict:"E",replace:!0,transclude:!0,require:"?ngModel",scope:{item:"=ngModel"},template:'<div class="searches">\n  <div class="search" ng-hide="museum_search_visible" ng-click="museum_search_visible=true; museum_input_focus = true">\n    <i class="icon-search"></i>\n    <a href="#">{{item || \'Search\' | i18next }}</a>\n  </div>\n  <div class="search_input" ng-show="museum_search_visible">\n    <input class="form-control" ng-model="item" placeholder="{{ "Search" | i18next }}" type="text" focus-me="museum_input_focus">\n    <a class="search_reset" href="#" ng-click="item=\'\'">\n      <i class="icon-remove-sign"></i>\n    </a>\n  </div>\n</div>',controller:function(e,t){return e.museum_search_visible=!1,e.museum_input_focus=!1,$(t).find(".search_input input").blur(function(){var t;return t=$(this),e.$apply(e.museum_input_focus=!1),t.animate({width:"150px"},150,function(){return e.$apply(e.museum_search_visible=!1),!0})}),$(t).find(".search_input input").focus(function(){var e,t;return e=$(this),t=$("body").width()-700,t>150?e.animate({width:""+t+"px"},300):void 0})},link:function(){return!0}}}).directive("canDragAndDrop",function(e,t){return{restrict:"A",scope:{model:"=model",url:"@uploadTo",selector:"@selector",selector_dropzone:"@selectorDropzone"},link:function(n,i){var r,a,s,o,l,u,d;return n.$parent.loading_in_progress=!1,o=50,i=$("#"+n.selector),s=$("#"+n.selector_dropzone),r=function(e){var t,n;return null!=e.files[0].name?(t=e.files[0].name.split(".").pop().toLowerCase(),n="unsupported",-1!==$.inArray(t,gon.acceptable_extensions.image)&&(n="image"),-1!==$.inArray(t,gon.acceptable_extensions.audio)&&(n="audio"),-1!==$.inArray(t,gon.acceptable_extensions.video)&&(n="video")):(n=e.files[0].type.split("/")[0],e.files[0].subtype=e.files[0].type.split("/")[1]),n},a=function(e){return e.files[0]&&e.files[0].size<1024*1024*o},u=function(){return $(".progress").hide(),setTimeout(function(){return $("body").removeClass("in"),n.$parent.loading_in_progress=!1,n.$parent.forbid_switch=!1},1e3)},d=function(){return n.$parent.loading_in_progress=!0,n.$parent.forbid_switch=!0,n.$digest(),$("body").addClass("in"),$(".progress .progress-bar").css("width","0%"),$(".progress").show()},l=[],i.fileupload({url:n.url,dataType:"json",dropZone:s,change:function(){return d()},drop:function(e,t){return d(),$.each(t.files,function(e,t){return console.log("Dropped file: "+t.name)})},add:function(i,s){var o,d;return d=r(s),"image"!==d&&"audio"!==d&&"video"!==d?(e.addError(t("Unsupported file type")),u()):a(s)?(l.push(d),o=n.model._id,("audio"===d||"video"===d)&&(o=n.model.stories[n.$parent.current_museum.language]._id),s.formData={type:d,parent:o},s.submit(),"audio"===d?n.model.stories[n.$parent.current_museum.language].audio="processing":void 0):(e.addError(t("File is bigger than 50mb")),u())},success:function(e){var t,i,r,a,s;for(s=[],r=0,a=e.length;a>r;r++)t=e[r],"image"===t.type?(null==n.model.images&&(n.model.images=[]),i={},i.image=t,i.mappings={},t.cover===!0&&n.$apply(n.model.cover=t),n.$apply(n.model.images.push(i))):"audio"===t.type?n.$apply(n.model.stories[n.$parent.current_museum.language].audio=t):"video"===t.type&&n.$apply(n.model.stories[n.$parent.current_museum.language].video=t),s.push(n.$digest());return s},error:function(n,i,r){var a,s;return"abort"===r?e.addError(t("Uploading aborted")):422===n.status?(a=jQuery.parseJSON(n.responseText),s=a.link[0],rrorProcessing.addError(t("Error during file upload. Prototype error"))):e.addError(t("Error during file upload. Prototype error")),e.addError(t("Error during file upload. Prototype error")),u()},progressall:function(e,r){var a,s,o,d,c;return s=parseInt(100*(r.loaded/r.total),10),a=102.4,o=Math.round(r.bitrate/a)/10,d=""+o+" Кб/с",o>1e3&&(o=Math.round(o/a)/10,d=""+o+" Мб/с"),$(".progress .progress-text").html(""+t("&nbsp;&nbsp; Uploaded")+" "+Math.round(r.loaded/1024)+" "+t("Kb of")+" "+Math.round(r.total/1024)+" "+t("Kb, speed:")+" "+d),$(".progress .progress-bar").css("width",s+"%"),r.loaded===r.total?(n.$parent.last_save_time=new Date,c=l.unique(),console.log(c),1===c.length&&"audio"===c[0]?console.log("file type is audio"):setTimeout(function(){var e;return e=i.parents("li").find("ul.images li.dragable_image a.img_thumbnail").last(),e.click()},1e3),i.parents("li").find("ul.images .museum_image_placeholder").hide(),l=[],u()):void 0}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled"),n.$watch("url",function(e){return e?i.fileupload("option","url",e):void 0})}}}).directive("buttonFileUpload",function(){return{restrict:"A",link:function(e,t){var n;return n=$(t),n.click(function(e){var t;return e.preventDefault(),n=$(this),t=n.parents("#drop_down, #museum_edit_dropdown"),t.find(":file").click()})}}}).directive("deleteMedia",function(e,t){return{restrict:"A",scope:{model:"=parent",media:"=media"},link:function(n,i){var r;return i=$(i),r=i.next(".delete_overlay"),i.click(function(i){var a,s,o,l,u;return i.preventDefault(),i.stopPropagation(),o=$(this),a=o.data("confirm"),l=o.data("show-overlay"),u=o.data("silent-delete"),s=function(){return t["delete"](o.data("link")).success(function(i){var a,s,o,u,d,c,p,m,g,f,h,_;if(l&&(r.hide(),r.find(".preloader").hide(),r.find(".overlay_controls, span").show()),"image"===n.media.type){for(h=n.model.images,s=p=0,g=h.length;g>p;s=++p)a=h[s],null!=a&&a.image._id===i._id&&(n.model.images.splice(s,1),a.image.cover===!0&&(d=n.model.images[0],d.image.cover=!0,n.model.cover=d.image,t.put(""+n.$parent.$parent.$parent.backend_url+"/media/"+d.image._id,d.image).success(function(){return console.log("ok")}).error(function(){return console.log("bad")})));0===n.model.images.length&&"published"===n.model.stories[n.$parent.$parent.$parent.current_museum.language].status&&e.checkValidity({item:n.model.stories[n.$parent.$parent.$parent.current_museum.language],root:n.model,field_type:"story"})}else if("audio"===n.media.type){for(c=n.$parent.$parent.active_exhibit,o=n.$parent.$parent.current_museum.language,n.model.audio=void 0,n.model.mapped_images=[],n.$parent.$parent.exhibit_timline_opened=!1,_=c.images,m=0,f=_.length;f>m;m++)a=_[m],u=a.mappings[o],null!=u&&(delete a.mappings[o],t["delete"](""+n.$parent.$parent.backend_url+"/media_mapping/"+u._id).success(function(e){return console.log(e)}).error(function(){return errorProcessing.addError($i18next("Failed to delete timestamp"))}));n.$digest(),"published"===n.model.status&&e.checkValidity({item:n.model,root:c,field_type:"story"})}return n.$parent.last_save_time=new Date})},l?(r.show(),r.find(".delete").unbind("click").bind("click",function(e){return r.find(".preloader").show(),r.find(".overlay_controls, span").hide(),s(),e.preventDefault()}),r.find(".btn-sm.cancel").unbind("click").bind("click",function(e){return r.hide(),e.preventDefault()})):u?s():confirm(a)?s():void 0})}}}).directive("dragAndDropInit",function(e){return{link:function(t){return $(document).bind("drop dragover",function(e){return e.preventDefault()}),$(document).bind("dragover",function(e){var n,i,r,a,s,o;if($(e.originalEvent.srcElement).hasClass("do_not_drop"))return e.preventDefault(),e.stopPropagation(),!1;for(i=$(".dropzone"),n=$("body"),o=t.dropZoneTimeout,o?clearTimeout(o):n.addClass("in"),r=!1,a=0,s=e.target;;){if(s===i[0]){r=!0,a=0;break}if(s===i[1]){r=!0,a=1;break}if(s=s.parentNode,null==s)break}return r?i[a].addClass("hover"):t.dropZoneTimeout=setTimeout(function(){return t.loading_in_progress?void 0:(t.dropZoneTimeout=null,i.removeClass("in hover"),n.removeClass("in"))},300)}),$(document).bind("drop",function(n){var i,r,a,s;if(i=$(n.originalEvent.target).parents("li").find("input[type='file']"),n.originalEvent.dataTransfer){if($(n.target).hasClass("do_not_drop"))return n.stopPropagation(),n.preventDefault(),!1;if(s=$(n.originalEvent.dataTransfer.getData("text/html")).filter("img").attr("src"))return s.indexOf("data:image")>=0?(a=s.split(";base64")[0].split("data:")[1],r=new Image,r.src=s,r.onload=function(){return e.cavas_processor(r,a)}):$.getImageData({url:s,server:""+t.backend_url+"/imagedata",success:e.cavas_processor})}})}}}).directive("urlUpload",function(e,t){return{restrict:"A",link:function(e,n){var i;return n=$(n),i=/^(http(s?):)|([/|.|\w|\s])*\.(?:jpg|jpeg|gif|png)?/,n.bind("paste",function(){return setTimeout(function(){var r,a;return a=n.val(),i.test(a)?(r="image/"+a.split(".").reverse()[0],console.log("ok"),n.parents("ul.images").find(".museum_image_placeholder").css({display:"inline-block"}),$.getImageData({url:a,server:""+e.$parent.backend_url+"/imagedata",success:function(e){return n.val(""),t.cavas_processor(e,r)}})):""!==a?(console.log("some error should be shown"),n.addClass("error"),setTimeout(function(){return n.removeClass("error")
},1500)):void 0},10)})}}}).directive("dropDownEdit",function(e,t){return{restrict:"A",link:function(e){var n,i,r,a,s;return s=null,a=null,i=null,n=null,r=null,e.$watch("active_exhibit.stories[current_museum.language]",function(o){return null!=s&&s(),null!=a&&a(),null!=i&&i(),null!=n&&n(),null!=r&&r(),null!=o?(s=e.$watch("active_exhibit.stories[current_museum.language].quiz",function(t,n){if(null!=t&&t!==n){if("published"===t.status)return console.log("pub"),$("#story_quiz_enabled").is(":checked")?setTimeout(function(){return $("#story_quiz_enabled").click()},10):setTimeout(function(){return e.quizform.$valid?void 0:setTimeout(function(){return $("#story_quiz_disabled").click()},10)},100);if(!$("#story_quiz_disabled").is(":checked"))return setTimeout(function(){return $("#story_quiz_disabled").click()},10)}}),a=e.$watch("active_exhibit.stories[current_museum.language].quiz.question",function(t,n){return null!=e.quizform&&t!==n?e.quizform.$valid?e.mark_quiz_validity(e.quizform.$valid):setTimeout(function(){return $("#story_quiz_disabled").click(),e.mark_quiz_validity(e.quizform.$valid)},10):void 0}),i=e.$watch("active_exhibit.stories[current_museum.language].name",function(t,n){var i;if(null!=t&&(i=$("#media form"),i.length>0))if("dummy"===e.active_exhibit.stories[e.current_museum.language].status){if(t)return e.active_exhibit.stories[e.current_museum.language].status="passcode"}else if(!e.new_item_creation&&!t)return e.active_exhibit.stories[e.current_museum.language].name=n,e.empty_name_error=!0,setTimeout(function(){return e.empty_name_error=!1},1500)}),n=e.$watch(function(){return null!=e.active_exhibit.stories[e.current_museum.language]?angular.toJson(e.active_exhibit.stories[e.current_museum.language].quiz.answers):void 0},function(t){return null!=t&&null!=e.quizform?e.quizform.$valid?e.mark_quiz_validity(e.quizform.$valid):setTimeout(function(){return $("#story_quiz_disabled").click()},10):void 0}),r=e.$watch("active_exhibit.stories[current_museum.language]",function(n){return n&&!e.active_exhibit.stories[e.current_museum.language].qr_code?t.get(""+e.backend_url+"/qr_code/"+e.active_exhibit.stories[e.current_museum.language]._id).success(function(t){return e.active_exhibit.stories[e.current_museum.language].qr_code=t}):void 0})):void 0})}}}).directive("openLightbox",function(){return{restrict:"A",link:function(e,t,n){var i,r;return t=$(t),r=t.parents("#drop_down, #museum_edit_dropdown"),i=r.find(".lightbox_area"),t.click(function(){return t.parents("li").hasClass("dragged")?t.parents("li").removeClass("dragged"):(i.show(),i.height()+45>r.height()&&r.height(i.height()+45),setTimeout(function(){return $(".slider:visible .thumb.item_"+n.openLightbox+" img").click()},100))}),!0}}}).directive("lightboxCropper",function(e,t,n){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=model"},template:'<div class="lightbox_area">\n  <ul class="nav nav-tabs">\n    <li ng-class="{\'active\': story_tab == \'thumb\'}">\n      <a href="#" ng-click="update_media(active_image_index); story_tab = \'thumb\'" >{{ \'Select thumbnail area\' | i18next }}</a>\n    </li>\n    <li ng-class="{\'active\': story_tab == \'full\'}">\n      <a href="#" ng-click="update_media(active_image_index); story_tab = \'full\'" >{{ \'Select fullsize image area\' | i18next }}</a>\n    </li>        \n  </ul>\n    <button class="btn btn-warning apply_resize" type="button">{{ "Done image editing" | i18next }}</button>\n    <div class="lightbox_preloader">\n      <img src="/img/big_loader_2.GIF">\n    </div>\n    <div class="content {{story_tab}}">\n      <div class="cropping_area {{story_tab}}">\n        {{story_tab}}\n        <img class="cropper_thumb" src="{{model.images[active_image_index].image.fullUrl || model.images[active_image_index].image.url}}">\n        <img class="cropper_full" src="{{model.images[active_image_index].image.url}}">\n      </div>\n      <div class="notification" ng-switch on="story_tab">\n        <span ng-switch-when="thumb">\n          {{ "Select the preview area. Images won\'t crop. You can always return to this later on." | i18next }}\n        </span>\n        <span ng-switch-when="full">\n          {{ "Images won\'t crop. You can always return to this later on." | i18next }}\n        </span>\n      </div>\n      <div class="preview" ng-hide="story_tab == \'full\'">\n        {{ "Thumbnail preview" | i18next }}\n        <div class="mobile">\n          <div class="image">\n            <img src="{{ model.images[active_image_index].image.fullUrl || model.images[active_image_index].image.url }}">\n          </div>\n        </div>\n      </div>\n    </div>\n    <div class="slider">\n      <ul class="images_sortable" sortable="model.images" lang="$parent.current_museum.language">\n        <li class="thumb item_{{$index}} " ng-class="{\'active\':image.image.active, \'timestamp\': image.mappings[lang].timestamp >= 0}" ng-repeat="image in images">\n          <img ng-click="$parent.$parent.set_index($index)" src="{{image.image.thumbnailUrl}}" />\n          <div class="label_timestamp" ng-show="image.mappings[lang].timestamp >= 0">\n            <span class="letter_label">\n              {{ image.image.order | numstring }}\n            </span>\n            <span class="time">\n              {{ image.mappings[lang].timestamp | timerepr }}\n            </span>\n          </div>\n          <a class="cover pointer_events" ng-class="{\'active\':image.image.cover}" ng-click="$parent.$parent.make_cover($index)" ng-switch on="image.image.cover">\n            <span ng-switch-when="true"><i class="icon-ok"></i> {{ "Cover" | i18next }}</span>\n            <span ng-switch-default><i class="icon-ok"></i> {{ "Set cover" | i18next }}</span>\n          </a>\n        </li>\n      </ul>\n    </div>\n</div>',controller:function(i){return i.set_index=function(e,t){return i.update_media(i.active_image_index,function(){return i.active_image_index=e,null!=t&&t!==i.story_tab?i.story_tab=t:void 0})},i.make_cover=function(r){var a,s,o,l,u;for(console.log("making a cover"),i.model.cover=i.model.images[r].image,l=i.model.images,u=[],s=0,o=l.length;o>s;s++)a=l[s],a.image._id!==i.model.cover._id?a.image.cover=!1:(a.image.cover=!0,i.model.cover=a.image,setTimeout(function(){return this.order=0}.bind(a.image)(),500)),u.push(e.put(""+i.$parent.backend_url+"/media/"+a.image._id,a.image).success(function(){return console.log("ok")}).error(function(){return t.addError(n("Failed to set cover"))}));return u},i.check_active_image=function(){var e,t,n,r,a,s;for(a=i.model.images,s=[],t=n=0,r=a.length;r>n;t=++n)e=a[t],s.push(e.image.active=t===i.active_image_index?!0:!1);return s}},link:function(i,r){var a,s,o,l,u,d,c,p,m,g,f,h,_,v,b,x,w,y,k,j,q,T,C;return i.story_tab="thumb",i.img_url="",r=$(r),b=r.find(".lightbox_preloader"),s=r.find(".content"),k=r.find("a.right"),f=r.find("a.left"),l=r.find(".cropping_area img.cropper_thumb"),o=r.find(".cropping_area img.cropper_full"),y=r.find(".mobile .image img"),u=r.find(".apply_resize"),v=r.parents("#drop_down, #museum_edit_dropdown"),m=0,g=0,p=0,c=0,h=330,_=450,x=133,w=177,q={},j={},a=[],u.click(function(){return i.update_media(i.active_image_index),i.story_tab="thumb",v.attr("style",""),r.hide(),!1}),i.update_media=function(r,a){var o;return console.log("updating media"),"full"===i.story_tab?(o=j,b.show(),s.hide(),console.log("hiding thumb")):o=q,null==i.model.images[i.active_image_index]&&(i.active_image_index=0),e.put(""+i.$parent.backend_url+"/resize_thumb/"+i.model.images[i.active_image_index].image._id,o).success(function(e){return delete i.model.images[r].image.url,delete i.model.images[r].image.fullUrl,delete i.model.images[r].image.selection,delete i.model.images[r].image.full_selection,delete i.model.images[r].image.thumbnailUrl,angular.extend(i.model.images[r].image,e),a&&a(),!0}).error(function(){return t.addError(n("Failed to update a thumbnail")),!1})},T=function(e){var t,n;return q=e,q.mode="thumb",t=177/q.w,n=133/q.h,y.css({width:Math.round(t*a[0])+"px",height:Math.round(n*a[1])+"px",marginLeft:"-"+Math.round(t*q.x)+"px",marginTop:"-"+Math.round(n*q.y)+"px"})},d=function(e){var t;return t=[e.x,e.y,e.x2,e.y2]},C=function(e){return j=e,j.mode="full",!0},l.on("load",function(){return console.log("thumb reloaded"),b.hide(),s.show(),setTimeout(function(){var e,t,n,r,s;return m=l.get(0).naturalWidth,c=l.get(0).naturalHeight,t=m,e=c,c>h&&(t=m*(h/c),e=h),t>_&&(e*=_/t,t=_),l.height(e),l.width(t),y.attr("style",""),r=i.model.images[i.active_image_index].image.selection,q=r?JSON.parse(r):{x:0,y:0,w:m,h:c,x2:m,y2:c,mode:"thumb"},n={boxWidth:l.width(),boxHeight:l.height(),setSelect:d(q),trueSize:[m,c],onChange:T,onSelect:T,aspectRatio:4/3},this.thumb_jcrop&&this.thumb_jcrop.destroy(),s=null,l.Jcrop(n,function(){return s=this,a=s.getBounds()}),T(q),this.thumb_jcrop=s}.bind(this),20)}),o.on("load",function(){return setTimeout(function(){var e,t,n,r,a,s;return g=o.get(0).naturalWidth,p=o.get(0).naturalHeight,r=g,n=p,p>h&&(r=g*(h/p),n=h),r>_&&(n*=_/r,a=_),o.height(n),o.width(r),t=i.model.images[i.active_image_index].image.full_selection,j=t?JSON.parse(t):{x:0,y:0,w:g,h:p,x2:g,y2:p,mode:"full"},s={boxWidth:o.width(),boxHeight:o.height(),setSelect:d(j),trueSize:[g,p],onChange:C,onSelect:C},this.full_jcrop&&this.full_jcrop.destroy(),e=null,o.Jcrop(s,function(){return e=this}),this.full_jcrop=e}.bind(this),20)}),i.$watch("model.images",function(e){var t,n,r;if(null!=e&&(i.story_tab="thumb",e.length>0)){for(n=0,r=e.length;r>n;n++)t=e[n],t.image.active=!1;return e[0].active=!0,f.css({opacity:0}),i.active_image_index=0}}),i.$watch("active_image_index",function(){return i.check_active_image()}),!0}}}).directive("sortable",function(e,t,n){return{restrict:"A",scope:{images:"=sortable",lang:"=lang"},link:function(e,t){var i;return t=$(t),i=e.$parent.backend_url||e.$parent.$parent.backend_url,t.disableSelection(),console.log(e.lang),t.sortable({placeholder:"ui-state-highlight",tolerance:"pointer",helper:"clone",cancel:".timestamp, .upload_item",items:"li:not(.timestamp):not(.upload_item)",scroll:!1,delay:100,start:function(e,n){return n.item.data("start",n.item.index()),n.helper.addClass("dragged"),t.parents(".description").find(".timline_container").addClass("highlite")},stop:function(r,a){var s,o,l,u,d,c,p,m,g;if(s=t.find("li"),c=a.item.data("start"),o=a.item.index(),e.images.splice(o,0,e.images.splice(c,1)[0]),t.parents(".description").find(".timline_container").removeClass("highlite"),e.images[o].image.order!==o){for(d={},g=e.images,u=p=0,m=g.length;m>p;u=++p)l=g[u],l.image.order=u,d[l.image._id]=u;return n.update_images(e.images[0].image.parent,d,i),e.$apply()}}})}}}).directive("jsDraggable",function(e,t,n){return{restrict:"A",link:function(t,i){var r;return i=$(i),r=n.weight_calc,i.draggable({axis:"x",containment:"parent",cursor:"pointer",start:function(e,n){var i;return i=t.$parent.container.stories[t.$parent.$parent.current_museum.language].mapped_images[n.helper.data("image-index")],i.dragging=!0},drag:function(i,r){var a,s;return a=n.calc_timestamp(r,!1),s=t.$parent.container.stories[t.$parent.$parent.current_museum.language].mapped_images[r.helper.data("image-index")],null!=s&&s.mappings[e.lang].timestamp!==a&&(s.mappings[e.lang].timestamp=a),!0},stop:function(i,r){var a,s,o,l,u,d,c,p;for(console.log("drag_stop"),a=n.calc_timestamp(r,!1),s=t.$parent.container.stories[t.$parent.$parent.current_museum.language].mapped_images[r.helper.data("image-index")],s.dragging=!1,t.$parent.set_hover(s,!1),null!=s&&s.mappings[e.lang].timestamp!==a&&(s.mappings[e.lang].timestamp=a),t.$parent.container.images.sort(n.sort_weight_func).sort(n.sort_time_func),u={},p=t.$parent.container.images,o=d=0,c=p.length;c>d;o=++d)l=p[o],l.image.order=o,u[l.image._id]=o,l.image._id===s.image._id&&n.update_image(l,t.$parent.$parent.backend_url);return n.update_images(s.image.parent,u,t.$parent.$parent.backend_url),t.$parent.$parent.$digest(),i.stopPropagation()}})}}}).directive("droppable",function(e,t,n,i){return{restrict:"A",link:function(e,t){return t=$(t),t.droppable({accept:".dragable_image",out:function(){return t.removeClass("can_drop")},over:function(){return t.addClass("can_drop")},drop:function(n,r){var a,s,o,l,u,d,c,p,m,g,f,h,_,v,b;for(h=t.hasClass("active_exhibit")?e.active_exhibit:t.hasClass("current_museum")?e.current_museum:void 0,t.removeClass("can_drop"),o=!1,a=r.draggable,s=$(this),a.attr("style",""),g=t.find(".jp-seek-bar"),d=t.find(".jp-duration"),c=t.find(".jp-play"),f=h.images[a.data("array-index")],p=h.stories[e.current_museum.language].mapped_images,null==p&&(p=[]),p.push(f),f.mappings[a.data("lang")]={},f.mappings[a.data("lang")].timestamp=i.calc_timestamp(r,!0),f.mappings[a.data("lang")].language=a.data("lang"),f.mappings[a.data("lang")].media=f.image._id,h.images.sort(i.sort_weight_func).sort(i.sort_time_func),m={},b=h.images,l=_=0,v=b.length;v>_;l=++_)u=b[l],u.image.order=l,m[u.image._id]=l;return i.update_images(f.image.parent,m,e.backend_url),i.create_mapping(f,e.backend_url),e.$digest(),e.recalculate_marker_positions(h.stories[e.current_museum.language],t)}}),!0}}}).directive("sortableNested",function(){return{restrict:"A",link:function(e,t){return t=$(t),t.nestedSortable({handle:"div.opener",items:"li.exhibit",listType:"ul",toleranceElement:"> div.opener"})}}}).directive("exhibitsSortable",function(e,t,n,i){return{restrict:"A",link:function(r,a,s){var o,l,u,d,c,p,m,g,f,h,_,v,b,x,w,y;return a=$(a),l=r.backend_url,a.disableSelection(),v=0,g="",p=0,c=0,d=0,h=0,m={},x=!1,w="",o=0,y=0,b=[],u=function(){switch(s.collection){case"common":return r.exhibits;case"published":return null!=r.grouped_exhibits?r.grouped_exhibits.published:[];case"private":return null!=r.grouped_exhibits?r.grouped_exhibits["private"]:[];case"invisible":return null!=r.grouped_exhibits?r.grouped_exhibits.invisible:[];case"draft":return null!=r.grouped_exhibits?r.grouped_exhibits.draft:[]}}(),_=function(e,t,n){var i,r,a,s,o;for(v=s=0,o=e.length;o>s;v=++s)if(r=e[v],r=$(r),a=r.offset(),i=h+c+a.left,p>t-i&&n>=a.top&&n<=a.top+d+30)return r;return null},f=function(e){var t,n,i;for(n=0,i=u.length;i>n;n++)if(t=u[n],t._id===e)return t;return null},a.sortable({placeholder:"exhibits_placeholder",tolerance:"intersect",helper:"clone",appendTo:document.body,cursor:"move",cursorAt:{left:-10,top:0},items:"> li.exhibit:not(.dummy)",scroll:!1,delay:100,start:function(e,t){var n;return v=t.item.data("exhibit-id"),m=f(v),g=m.stories[r.current_museum.language].name,m.active=!0,t.item.show(),t.helper.html("<span class='info'>Move "+g+"</span>").addClass("exhibits_info"),t.helper.addClass("dragged"),p=parseInt($(a.find("li.exhibit")[1]).css("margin-left").split("px")[0],10),c=t.item.width(),d=t.item.height(),h=parseInt($(a.find("li.exhibit")[0]).css("margin-left").split("px")[0],10),n=p/2,a.find(".exhibits_placeholder").html("<span class='helper'></span>").find(".helper").css({"margin-left":""+n+"px"}),r.grid()},sort:function(e,t){var n,i,s,l,d,c,p,m,h,v,b,y,k,j,q;if(x=r.selected_count>1?!0:!1,h=$(e.toElement),v=h.parents("li.exhibit"),0===v.length)d=x?"Move "+r.selected_count+" exhibits":"Move "+g,s=_(h.find("li.exhibit"),e.pageX,e.pageY),null!=s&&(o=s.data("exhibit-id"),l=f(o),w=l.number.split("."),w[w.length-1]=parseInt(w[w.length-1],10)+1);else{if(y=v.data("exhibit-id"),b=f(y),c=y+1<u.length?f(y+1).number.split("."):[999999999],n=b.number.split("."),n.length<=c.length||c[0]>n[0])w=n,w.push(1);else for(i=k=j=y+1,q=u.length-2;q>=j?q>=k:k>=q;i=q>=j?++k:--k)c=f(i+1).number,n=f(i).number,c.length!==n.length&&(m=n.split("."),p=m[m.length-1],p=parseInt(p,10)+1,m[m.length-1]=p,w=m);d=x?"Move "+r.selected_count+" exhibits":""+w.join(".")+" "+g}return a.find(".exhibits_placeholder").insertAfter(s),t.helper.find(".info").text(d)},stop:function(s,o){var l,d,c,p,g,h,_,y,k,j,q,T,C,z,E,I,M,A;if(p=a.find("li"),m.active=!1,g=o.item.data("exhibit-id"),f(g).number=w.join("."),_=f(g)._id,x)for(b=a.find("li.exhibit.selected:not(.active)"),b.insertAfter(o.item),v=C=0,I=b.length;I>C;v=++C)h=b[v],h=$(h),m=f(h.data("exhibit-id")),new_item_number[w.length-1]=parseInt(w[w.length-1],10)+1+v,m.number=new_item_number.join(".");for(u=n.sortArray(u),q=!1,v=z=0,A=u.length-2;A>=0?A>=z:z>=A;v=A>=0?++z:--z)d=u[v],k=u[v+1],l=d.number.split("."),y=k.number.split("."),l.length===y.length?(j=parseInt(y[y.length-1],10),c=parseInt(l[l.length-1],10),q=!1,j!==c+1&&(q=!0,y[y.length-1]=c+1,k.number=y.join("."))):y.length>l.length?(q===!0&&y[y.length-2]!==l[l.length-1]&&console.log("item was incremented and next item is child of"),1!==y[y.length-1]&&(y[y.length-1]=1),k.number=y.join(".")):y.length<l.length&&(j=parseInt(y[y.length-1],10),c=parseInt(l[l.length-2],10),q=!1,y[y.length-1]!==c+1&&(q=!0,y[y.length-1]=c+1,k.number=y.join(".")));for(r.$digest(),r.grid(),setTimeout(function(){return a.sortable().refresh()},100),T={},E=0,M=u.length;M>E;E++)m=u[E],T[m._id]=m.number;return e.post(""+r.backend_url+"/story_set/update_numbers/"+r.current_museum._id,T).success(function(e){return console.log(e),setTimeout(function(){return a.sortable("enable")},100),!0}).error(function(){return t.addError(i("Failed to save sort status"))})}})}}}).directive("switchToggle",function(e,t){return{restrict:"A",controller:function(n,i,r,a,s){var o;return o=a.quizSwitch,n.quiz_state=function(i,r){return n.mark_quiz_validity(i.$valid),i.$valid?e(function(){return s.put(""+n.backend_url+"/quiz/"+r._id,r).success(function(e){return console.log(e)}).error(function(){return errorProcessing.addError(t("Failed to save quiz state"))}),!0},0):setTimeout(function(){return $("#"+o+"_disabled").click()},300),!0},n.mark_quiz_validity=function(e){var t,n;return t=$("#"+o+" form"),e?t.removeClass("has_error"):(t.addClass("has_error"),n=t.find("#story_quiz_attributes_question, #museum_story_quiz_attributes_question"),""===n.val()&&n.addClass("ng-invalid")),!0}},link:function(e,n,i){var r;return r=i.quizSwitch,$("#"+r+"_enabled, #"+r+"_disabled").change(function(){var e;return e=$(this),e.attr("id")===""+r+"_enabled"?($("label[for="+r+"_enabled]").text(t("Enabled")),$("label[for="+r+"_disabled]").text(t("Disable")),!0):($("label[for="+r+"_disabled]").text(t("Disabled")),$("label[for="+r+"_enabled]").text(t("Enable")),!0)})}}}).directive("errorNotification",function(e){return{restrict:"E",replace:!0,transclude:!0,template:'<div class="error_notifications" ng-hide="errors.length == 0">\n  <div class="alert alert-danger" ng-repeat="error in errors">\n    {{error.error}}\n    <a class="close" href="#" ng-click="dismiss_error($index)" >&times;</a>\n  </div>\n</div>',link:function(t){return t.errors=e.getErrors(),t.dismiss_error=function(t){return e.deleteError(t)},t.$on("new_error",function(e,n){return t.errors=n})}}}).directive("toTop",function(){return{restrict:"E",replace:!0,transclude:!0,template:'<div class="to_top">\n  <div class="to_top_panel">\n    <div class="to_top_button" title="Наверх">\n      <span class="arrow"><i class="icon-long-arrow-up"></i></span>\n    </div>\n  </div>\n</div>',link:function(e,t){return t=$(t),t.click(function(){var e;return t.hasClass("has_position")?(t.removeClass("has_position"),e=t.data("scrollPosition"),t.find(".arrow i").removeClass("icon-long-arrow-down").addClass("icon-long-arrow-up"),$.scrollTo(e,0)):(t.addClass("has_position"),e=$(document).scrollTop(),t.data("scrollPosition",e),t.find(".arrow i").addClass("icon-long-arrow-down").removeClass("icon-long-arrow-up"),$.scrollTo(0,0))})}}}).directive("langList",function(){return{restrict:"E",replace:!0,transclude:!0,template:'<ul class="nav nav-tabs lang_list">\n  <li class="active">\n    <a href="#" class="dropdown-toggle">\n      {{current_museum.language | i18next}}\n      <i class="icon-chevron-down"></i>\n    </a>\n    <ul class="dropdown-menu">\n      <li ng-repeat="story in lang_arr">\n        <a href="#" ng-click="current_museum.language = story.language">{{ story.language | i18next}}</a>\n      </li>\n      <li class="divider" ng-hide="lang_arr.length == 0"></li>\n      <li>\n        <a href="#" ng-click="new_museum_language()"> {{ \'newLanguage\' | i18next }} </a>\n      </li>\n    </ul>        \n  </li>\n</ul>',link:function(e){var t,n;return n=function(t){var n;return n=0,t.language===e.current_museum.language&&(n-=100),n},t=function(e,t){return n(e)>n(t)?1:n(e)<n(t)?-1:0},e.$watch("current_museum.language",function(){var n,i,r;e.lang_arr=[],r=e.current_museum.stories;for(n in r)i=r[n],e.lang_arr.push(i);return e.lang_arr.sort(t),e.lang_arr.splice(0,1)})}}})}).call(this);