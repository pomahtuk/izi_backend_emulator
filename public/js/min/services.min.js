(function(){"use strict";angular.module("Museum.services",[]).service("sharedProperties",function(e){var r;return r={},{getProperty:function(e){return r[e]},setProperty:function(t,i){return r[t]=i,e.$broadcast("exhibitChange")}}}).service("storySetValidation",function(e,r){return{checkValidity:function(r){return null==r.item.images&&(r.item.images=[]),null==r.item.long_description&&(r.item.long_description=""),0!==r.item.long_description.length&&r.item.audio&&null!=r.root.number&&r.root.images.length>=1?(this.markValid(r),e.$broadcast("changes_to_save",r)):this.markInvalid(r)},markInvalid:function(t){return console.log("invalid"),"published"===t.item.status?(t.root.invalid=!0,r(function(){return t.item.status="passcode",null!=t.$digest&&t.$digest(),e.$broadcast("changes_to_save",t)},100)):e.$broadcast("changes_to_save",t)},markValid:function(e){return console.log("valid"),e.root.invalid=!1}}}).service("imageMappingHelpers",function(e,r,t,i){var n;return n=function(r){var t;return t=0,t+=r.image.order,null!=r.mappings[e.lang]&&(t-=100),t},{sort_weight_func:function(e,r){return n(e)>n(r)?1:n(e)<n(r)?-1:0},sort_time_func:function(r,t){if(null!=r.mappings[e.lang]&&null!=t.mappings[e.lang]&&r.mappings[e.lang].timestamp>=0){if(r.mappings[e.lang].timestamp>t.mappings[e.lang].timestamp)return 1;if(r.mappings[e.lang].timestamp<t.mappings[e.lang].timestamp)return-1}return 0},calc_timestamp:function(e,r){var t,i,n,s,a,o,u,l,c;return null==r&&(r=!1),l=$(".jp-seek-bar:visible"),a=$(".jp-duration:visible"),o=$(".jp-play:visible"),i=r?e.offset.left-l.offset().left:e.position.left-o.width(),t=l.width()-15,s=a.text(),c=parseInt(s.split(":")[1],10)+60*parseInt(s.split(":")[0],10),u=c/t,n=Math.round(i*u),0>=n&&(n=0),n},update_image:function(n,s){return t.put(""+s+"/media/"+n.image._id,n.image).success(function(){var a;return console.log("ok"),null!=n.mappings[e.lang]&&(a=n.mappings[e.lang],null!=a._id)?t.put(""+s+"/media_mapping/"+a._id,a).success(function(){return console.log("ok")}).error(function(){return r.addError(i("Failed to set timestamp"))}):void 0}).error(function(){return r.addError(i("Failed to set timestamp"))}),!0},update_images:function(e,n,s){return t.post(""+s+"/media_for/"+e+"/reorder",n).success(function(){return console.log("ok")}).error(function(){return r.addError(i("Failed to update order"))}),!0},create_mapping:function(n,s){return t.post(""+s+"/media_mapping/",n.mappings[e.lang]).success(function(r){return n.mappings[e.lang]=r}).error(function(){return r.addError(i("Failed to set timestamp"))}),!0}}}).service("uploadHelpers",function(){return{cavas_processor:function(e,r){var t;return null==r&&(r="image/jpeg"),console.log("called"),t=document.createElement("canvas"),t.width=e.width,t.height=e.height,t.getContext&&t.toBlob&&(t.getContext("2d").drawImage(e,0,0,e.width,e.height),t.toBlob(function(e){var r;return r=$("#drop_down, #museum_drop_down").filter(":visible").find("input[type=file]"),r.fileupload("add",{files:[e]})},r)),!0}}}).service("errorProcessing",function(e){return{errors:[],addError:function(r){var t;return t={error:r},this.errors.push(t),e.$broadcast("new_error",this.errors)},getErrors:function(){return this.errors},clearErrors:function(){return this.errors=[],e.$broadcast("new_error",this.errors)},deleteError:function(r){return this.errors.splice(r,1),e.$broadcast("new_error",this.errors)}}}).service("backendWrapper",function(e,r,t,i){return{museum_id:"5285b3417de600691f000002",content_provider_id:"5285b3417de600691f000001",backend_url:"http://192.168.158.128:3000/api",museums:[],exhibits:[],modal_translations:[],langs:[],current_museum:{},active_exhibit:{},sort_field:"number",sort_direction:1,ajax_progress:!0,grouped_positions:{},hier_exhibits:{},sortArray:function(e,r,t){var i,n,s,a,o,u,l,c,m,d,g,p,h,f,_;for(null==r&&(r=r),null==t&&(t=t),l=[],s=void 0,a=1===t?1:-1,i=m=0,p=e.length;p>m;i=++m)for(n=e[i],l[i]=n,l[i].number=null!=n.number?n.number.toString().match(/([^0-9]+)|([0-9]+)/g):[""],_=l[i].number,u=d=0,h=_.length;h>d;u=++d)o=_[u],isNaN(s=parseInt(l[i].number[u]))||(l[i].number[u]=s);for(l.sort(function(e,r){var t,i,n,s;for(s=e.number,t=i=0,n=s.length;n>i;t=++i){if(o=s[t],e.number[t]<r.number[t])return 0+a;if(e.number[t]>r.number[t]||r.number.length<t)return 0-a}return 0}),g=0,f=l.length;f>g;g++)c=l[g],c.number=c.number.join("");return l},recurse_enter_hierarchy:function(e,r,t){var i;return i=parseInt(r[0],10),null==e[i]&&(e[i]={}),1===r.length?e[i]={0:t}:(r.splice(0,1),this.recurse_enter_hierarchy(e[i],r,t))},form_hierarchial_object:function(e){var r,t,i,n,s;for(i={},n=0,s=e.length;s>n;n++)t=e[n],r=t.number.split("."),this.recurse_enter_hierarchy(i,r,t);return i},reload_exhibits:function(t,i,n){var s;return null==t&&(t=t),null==i&&(i=i),s=e.get(""+this.backend_url+"/provider/"+this.content_provider_id+"/museums/"+this.museum_id+"/exhibits/"+this.sort_field+"/"+this.sort_direction),s.success(function(e){var t,i,s,a,o,u,l,c,m,d,g,p,h,f,_,b;for(a=[],u=0,d=e.length;d>u;u++)if(s=e[u],null!=s){for(t=s.exhibit,t.images=[],t.mapped_images=[],t.cover={},f=s.images,l=0,g=f.length;g>l;l++)i=f[l],t.images.push(i),i.image.cover===!0&&(t.cover=i.image);for(t.stories={},_=s.stories,c=0,p=_.length;p>c;c++){for(o=_[c],o.story.quiz=o.quiz.quiz,o.story.audio=o.audio,o.story.video=o.video,o.story.quiz.answers=o.quiz.answers,o.story.mapped_images=[],b=t.images,m=0,h=b.length;h>m;m++)i=b[m],i.mappings[o.story.language]&&o.story.mapped_images.push(i);t.stories[o.story.language]=o.story}a.push(t)}return r.complete(),console.log("anim completed"),a=this.sortArray(a),this.hier_exhibits=this.form_hierarchial_object(a),this.active_exhibit=a[0],this.exhibits=a,this.ajax_progress=!1,0===a.length&&(this.active_exhibit={index:0,name:"Богоматерь Владимирская, с двунадесятыми праздниками",number:"1",image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",publish_state:"all",description:"",qr_code:{url:"/img/qr_code.png",print_link:"http://localhost:8000/img/qr_code.png"},images:[{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:1,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"},{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:2,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"}],stories:{ru:{name:"Богоматерь Владимирская, с двунадесятыми праздниками",description:"test description",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}}}}),null!=n?n.resolve():void 0}.bind(this)),s.error(function(){return r.complete(),null!=n?n.reject():void 0})},fetch_data:function(t,n){var s;return r.color("#fd6e3b"),r.start(),console.log("anim started",t),null!=t&&(this.museum_id=t),s=e.get(""+this.backend_url+"/provider/"+this.content_provider_id+"/museums"),s.success(function(e){var r,t,s,a,o,u,l,c,m,d,g,p,h,f,_,b,v,y,x,w;for(this.museums=[],r=!1,this.langs=[],this.modal_translations={},l=0,g=e.length;g>l;l++){for(s=e[l],o=s.exhibit,o.def_lang="ru",null==o.language&&(o.language="ru"),o.package_status="process",o.stories={},o.images=[],o.mapped_images=[],o.cover={},v=s.images,c=0,p=v.length;p>c;c++)t=v[c],o.images.push(t),t.image.cover===!0&&(o.cover=t.image);for(y=s.stories,m=0,h=y.length;h>m;m++){for(u=y[m],u.story.city="Saint-Petersburg",u.story.quiz=u.quiz.quiz,u.story.audio=u.audio,u.story.video=u.video,u.story.quiz.answers=u.quiz.answers,u.story.mapped_images=[],x=o.images,d=0,f=x.length;f>d;d++)t=x[d],t.mappings[u.story.language]&&u.story.mapped_images.push(t);o.stories[u.story.language]=u.story,this.langs.push(u.story.language)}this.museums.push(o),o.active=!1,o._id===this.museum_id&&(o.active=!0,this.current_museum=o,r=!0),this.langs.unique()}for(this.museums=this.sortArray(this.museums),r||(this.current_museum=this.museums[0],this.current_museum.def_lang="ru",null==o.language&&(this.current_museum.language="ru"),this.museum_id=this.current_museum._id),w=this.langs,b=0,_=w.length;_>b;b++)a=w[b],this.modal_translations[a]={name:i(a)};return this.reload_exhibits(null,null,n)}.bind(this)),s.error(function(){return r.complete(),null!=n?n.reject():void 0})}}})}).call(this);