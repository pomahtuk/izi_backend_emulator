(function(){"use strict";var e,t,n;Object.defineProperty(Array.prototype,"unique",{value:function(){var e,t,n,r;for(e=[],r=this.length,t=0;r>t;){for(n=t+1;r>n;)this[t]===this[n]&&(n=++t),n++;e.push(this[t]),t++}return e},enumerable:!1}),$.fn.refresh=function(){return $(this.selector)},$.fn.isEmpty=function(){return 0===this.length},t=function(e){var t,n;return e=$(e),n=e.offset().top,t=function(){return n<$(this).offset().top},$.merge(e,e.nextUntil(t)).last()},e=function(e,t){return e.length>0&&t.length>0&&e.offset().top===t.offset().top},n=function(e,t,n,r){var i,s,u,o,a,l;return l=$(window).innerWidth(),o=t+n,a=l-2*r+n,s=Math.floor(a/o),i=l-(s*o-n),u=Math.floor(i/2),e.css({"margin-right":0,"margin-left":n}),e.each(function(e){return 0===e%s?$(this).css({"margin-left":u}):void 0})},this.gon={google_api_key:"AIzaSyCPyGutBfuX48M72FKpF4X_CxxPadq6r4w",acceptable_extensions:{audio:["mp3","ogg","aac","wav","amr","3ga","m4a","wma","mp4","mp2","flac"],image:["jpg","jpeg","gif","png","tiff","bmp"],video:["mp4","m4v","avi","ogv"]},development:!1},angular.module("Museum.controllers",[]).controller("IndexController",["$rootScope","$scope","$http","$filter","$window","$modal","$routeParams","$location","ngProgress","storySetValidation","errorProcessing","$i18next","imageMappingHelpers","backendWrapper",function(r,i,s,u,o,a,l,c,d,m,_,p,g,h){var f,b,v,w,y,x,k;return window.sc=i,i.exhibit_search="",i.changeLng=function(e){return p.options.lng=e},i.criteriaMatch=function(e){return function(t){var n,r,s;return t&&t.stories[i.current_museum.language]&&t.stories[i.current_museum.language].name&&null!=e&&"string"==typeof e?(n=t.stories[i.current_museum.language].name.toLowerCase().indexOf(e.toLowerCase())>-1,r=parseInt(t.number,10)===parseInt(e,10),s=n||""===e||r):!0}},i.statusMatch=function(e){return null==e&&(e=i.exhibits_visibility_filter),function(t){return"all"!==e&&t&&null!=t.stories[i.current_museum.language]&&t.stories[i.current_museum.language].status&&e&&t.stories[i.current_museum.language].status!==e?!1:!0}},i.sort_field="number",i.sort_direction=1,i.sort_text="icon-sort-by-order",i.exhibits_visibility_filter="all",i.ajax_progress=!0,i.story_subtab="video",i.story_tab="main",i.museum_tab="main",i.museum_subtab="video",i.grouped_positions={draft:!1,passcode:!1,invisible:!1,published:!1},angular.extend(i,h),i.user={mail:"pman89@yandex.ru",providers:[{name:"IZI.travel Test Provider"},{name:"IZI.travel Second Provider"}]},i.provider={name:"content_1",id:"1",passcode:"passcode",passcode_edit_link:"/1/pass/edit/"},i.translations={ru:"Russian",en:"English",es:"Spanish",ge:"German",fi:"Finnish",sw:"Sweedish",it:"Italian",fr:"French",kg:"Klingon"},i.element_switch=!0,i.forbid_switch=!1,i.create_new_language=!1,f=$("#drop_down").removeClass("hidden").hide(),b=function(){return $("ul.exhibits li.exhibit.active")},i.dummy_focusout_process=function(){var e,t,n,r,s;if(""===f.find("#name").val()){for(t=!0,s=f.find("#media .form-control:not(#opas_number)"),n=0,r=s.length;r>n;n++)e=s[n],e=$(e),""!==e.val()&&(t=!1);return t?i.new_item_creation=!1:i.dummy_modal_open()}},i.closeDropDown=function(){var e;return console.log("closing"),e=b(),null!=i.active_exhibit&&(i.active_exhibit.active=!1),e.hasClass("dummy")&&i.dummy_focusout_process(e),f.hide(),e.removeClass("active")},i.attachDropDown=function(e){var n;return e=$(e),n=f.hasClass("inited"),f.show().insertAfter(t(e)),n?void 0:(f.addClass("inited"),f.find("a.done, .close").not(".delete_maping").unbind("click").bind("click",function(e){return e.preventDefault(),i.closeDropDown()}),f.find(">.prev-ex").unbind("click").bind("click",function(e){var t,n;return e.preventDefault(),t=b(),n=t.prev(".exhibit"),("drop_down"===n.attr("id")||n.hasClass("dummy"))&&(n=n.prev()),n.length>0?n.find(".opener .description").click():t.siblings(".exhibit").last().find(".opener").click()}),f.find(">.next-ex").unbind("click").bind("click",function(e){var t,n;return e.preventDefault(),t=b(),n=t.next(),("drop_down"===n.attr("id")||n.hasClass("dummy"))&&(n=n.next()),n.length>0?n.find(".opener .description").click():t.siblings(".exhibit").first().find(".opener").click()}),f.find("a.delete_story").unbind("click").bind("click",function(e){var t;return t=$(this),t.hasClass("no_margin")?(e.preventDefault(),e.stopPropagation(),i.closeDropDown()):void 0}))},i.open_dropdown=function(t,n){var r,s,u,o,a,l,c,d,m;if(r=$(t.target).parents("li"),i.element_switch=!0,i.forbid_switch===!0)return t.stopPropagation(),!1;if(r.hasClass("active")&&!i.new_item_creation)return i.closeDropDown(),!1;for(i.new_item_creation&&(i.story_tab="main",b().length>0&&i.closeDropDown()),m=i.exhibits,c=0,d=m.length;d>c;c++)u=m[c],null!=u&&(u.active=!1);return n.active=!0,setTimeout(function(){return i.element_switch=!1},500),i.active_exhibit=n,l=b(),l.hasClass("dummy")&&i.dummy_focusout_process(l),l.removeClass("active"),r.addClass("active"),e(r,l)||(i.attachDropDown(r),setTimeout(function(){return $.scrollTo(r,500)},100)),o=f.find(".item_publish_settings"),s=f.find(".delete_story"),"images"===i.story_tab&&(i.story_tab="main"),r.hasClass("dummy")?(a=r.data("number"),$("#opas_number").val(a).blur(),$("#name").focus(),o.hide(),s.addClass("no_margin")):(o.show(),s.removeClass("no_margin"))},i.museum_type_filter="",i.grid=function(){return $("ul.exhibits").each(function(){var e,t,r,i;return e=$(this).find("li.exhibit"),t=0,i=e.first().width(),r=35,n(e,i,r,t)})},i.museum_list_prepare=function(){var e,t,n,r;return t=$("ul.museum_list"),e=t.find("li").length,r=$("body").width(),n=(150*e+160)/r,n>1?($(".museum_filters").show(),t.width(r-200)):($(".museum_filters").hide(),t.width(r-100))},setTimeout(function(){return i.museum_list_prepare()},200),$(window).resize(function(){return setTimeout(function(){return i.museum_list_prepare()},100)}),$(".page-wrapper").click(function(){var e;return e=$(".museum_navigation_menu"),e.height()>10?e.slideUp(100):void 0}),i.new_item_creation=!1,i.all_selected=!1,i.modal_options={current_language:{name:i.translations[i.current_museum.language],language:i.current_museum.language},languages:i.modal_translations,exhibits:i.exhibits,deletion_password:"123456"},y=function(){var e;return e=0,e=i.exhibits[i.exhibits.length-1]?parseInt(i.exhibits[i.exhibits.length-1].number,10)+1:1},v=function(){return i.current_museum.language},x=function(e){return e===i.current_museum.language?"passcode":"dummy"},w=function(e){return e===i.current_museum.language?"Экспонат_"+e:""},i.set_hover=function(e,t){return e.image.hovered=t},i.check_mapped=function(e){var t,n,r,s;return console.log("checking mapping"),r=$(e.target),n=r.parents(".description").find(".timline_container"),s=r.hasClass("active_exhibit")?i.active_exhibit:r.hasClass("current_museum")?i.current_museum:void 0,s.stories[i.current_museum.language].mapped_images.length>0?(t=s.stories[i.current_museum.language],setTimeout(function(){return i.recalculate_marker_positions(t,n)},100)):void 0},i.delete_mapping=function(e,t,n){var r,u,o;return o="active_exhibit"===t?i.active_exhibit:i.current_museum,r=o.images[e],u=i.current_museum.language,s["delete"](""+i.backend_url+"/media_mapping/"+r.mappings[u]._id).success(function(t){var n,s,a,l,c,d,m,_,p,h;for(console.log("ok",t),p=o.stories[u].mapped_images,l=c=0,m=p.length;m>c;l=++c)if(s=p[l],s.image._id===r.image._id){o.stories[u].mapped_images.splice(l,1);break}for(delete r.mappings[u],o.images.sort(g.sort_weight_func).sort(g.sort_time_func),a={},h=o.images,e=d=0,_=h.length;_>d;e=++d)n=h[e],n.image.order=e,a[n.image._id]=e;return g.update_images(o.images[0].image.parent,a,i.backend_url)}).error(function(){return _.addError(p("Failed to delete timestamp"))}),n.preventDefault(),n.stopPropagation()},i.recalculate_marker_positions=function(e){var t,n,r,s,u,o,a,l,c,d,m,_,p,g,h;for(d=$(".jp-seek-bar:visible"),u=$(".jp-duration:visible"),o=$(".jp-play:visible"),n=o.width(),t=d.width()-15,r=u.text(),m=parseInt(r.split(":")[1],10)+60*parseInt(r.split(":")[0],10),c=m/t,g=$(".image_connection:visible"),h=[],_=0,p=g.length;p>_;_++)l=g[_],l=$(l),s=e.mapped_images[l.data("image-index")],a=s.mappings[i.current_museum.language].timestamp/c,h.push(l.css({left:""+(a+n)+"px"}));return h},i.create_dummy_story=function(e){var t,n,r;for(t={playback_algorithm:"generic",content_provider:i.content_provider_id,story_type:"story",status:"draft",language:"dummy",name:"",short_description:"",long_description:"",story_set:e},t.quiz={story:"",question:"",comment:"",status:"passcode",answers:[]},n=r=0;3>=r;n=++r)t.quiz.answers.push({quiz:"",content:"",correct:!1});return t.quiz.answers[0].correct=!0,t},i.new_museum_language=function(){var e,t;return i.create_new_language=!0,t=i.create_dummy_story(i.current_museum._id),t.quiz.answers[0].correct=!0,i.dummy_museum=angular.copy(i.current_museum),i.dummy_museum.stories.dummy=t,i.dummy_museum.stories.dummy.status="passcode",i.dummy_museum.language="dummy",i.modal_options={museum:i.dummy_museum,translations:i.translations},e=a.open({templateUrl:"myMuseumModalContent.html",controller:ModalMuseumInstanceCtrl,resolve:{modal_options:function(){return i.modal_options}}}),e.result.then(function(e){var t,n;switch(e){case"save":return console.log(i.dummy_museum),t=i.dummy_museum.language,i.dummy_museum.stories[t]=i.dummy_museum.stories.dummy,i.dummy_museum.stories[t].language=t,n=i.dummy_museum.stories[t],n.story_set=i.current_museum._id,i.post_stories(n,"uncommon",function(e){var r,s,u,o,a;for(e.quiz=n.quiz,a=i.exhibits,u=0,o=a.length;o>u;u++)r=a[u],r.stories[t]=angular.copy(n),r.stories[t].language=t,r.stories[t].name="",r.stories[t].status="draft",r.stories[t].story_set=r._id,s=angular.copy(r.stories[t]),i.post_stories(s,"uncommon");return i.current_museum.stories[t]=e,i.modal_translations[t]={name:i.translations[t]},i.current_museum.language=t,i.create_new_language=!1});case"discard":return!0}},function(){return console.log("Modal dismissed at: "+new Date)}),!0},i.create_new_item=function(){var e,t,n,r;if(i.new_item_creation!==!0){n=y(),i.new_exhibit={content_provider:i.content_provider_id,number:n,type:"exhibit",distance:20,duration:20,status:"draft",route:"",category:"",parent:i.museum_id,name:"",qr_code:{url:"",print_link:""},stories:{}},i.new_exhibit.images=[];for(t in i.current_museum.stories){for(i.new_exhibit.stories[t]={playback_algorithm:"generic",content_provider:i.content_provider_id,story_type:"story",status:"draft",language:t,name:"",short_description:"",long_description:"",story_set:""},i.new_exhibit.stories[t].quiz={story:"",question:"",comment:"",status:"passcode",answers:[]},e=r=0;3>=r;e=++r)i.new_exhibit.stories[t].quiz.answers.push({quiz:"",content:"",correct:!1});i.new_exhibit.stories[t].quiz.answers[0].correct=!0}return i.new_item_creation=!0,setTimeout(function(){var e;return i.story_tab="main",e={},e.target=$("li.exhibit.dummy:visible > .opener.draft"),i.open_dropdown(e,i.new_exhibit),i.grid()},30)}},i.check_selected=function(){var e,t,n,r;for(i.selected_count=0,i.select_all_enabled=!1,r=i.exhibits,t=0,n=r.length;n>t;t++)e=r[t],e.selected===!0&&(i.select_all_enabled=!0,i.selected_count+=1);return i.selected_count===i.exhibits.length?i.all_selected=!0:void 0},i.select_all_exhibits=function(e){var t,n,r,s,u;if(null!=e)switch(e){case"select":n=!0;break;case"cancel":n=!1}else n=!i.all_selected;for(u=i.exhibits,r=0,s=u.length;s>r;r++)t=u[r],t.selected=n;return i.all_selected=!i.all_selected,i.select_all_enabled=n},i.delete_modal_open=function(){var e;return i.new_item_creation?!0:(i.modal_options={current_language:{name:i.translations[i.current_museum.language],language:i.current_museum.language},languages:i.modal_translations,exhibits:i.exhibits,deletion_password:"123456"},e=a.open({templateUrl:"myModalContent.html",controller:ModalDeleteInstanceCtrl,resolve:{modal_options:function(){return i.modal_options}}}),e.result.then(function(e){return i.delete_exhibit(i.active_exhibit,e.selected)},function(){return console.log("Modal dismissed at: "+new Date)}))},i.delete_museum_modal_open=function(){var e;return i.new_item_creation?!0:(i.modal_options={current_language:{name:i.translations[i.current_museum.language],language:i.current_museum.language},languages:i.modal_translations,exhibits:i.exhibits,deletion_password:"123456"},e=a.open({templateUrl:"museumDelete.html",controller:museumDeleteCtrl,resolve:{modal_options:function(){return i.modal_options}}}),e.result.then(function(e){var t,n,r,s,u,o,a,l,c;if(n=i.current_museum.language,"lang"===e){for(delete i.modal_translations[n],i.current_museum.language=i.current_museum.def_lang,l=i.exhibits,s=0,o=l.length;o>s;s++)t=l[s],i.delete_story(t.stories,n,function(e,t){return delete e[t],!0});return i.delete_story(i.current_museum.stories,n,function(e,t){return delete e[t],!0})}for(console.log("deleting museum story or whole museum"),r=i.current_museum,c=i.exhibits,u=0,a=c.length;a>u;u++)t=c[u],i.delete_story_set(t);return i.delete_story_set(r)},function(){return console.log("Modal dismissed at: "+new Date)}))},i.delete_exhibit=function(e,t){var n,r,s,u,o,a,l,c,d,m,_;if(t.length>=Object.keys(e.stories).length){for(i.closeDropDown(),c=i.exhibits,m=[],r=a=0,l=c.length;l>a;r=++a){if(n=c[r],n._id===e._id){i.exhibits.splice(r,1),i.grid(),e._id===i.active_exhibit._id&&(i.active_exhibit=i.exhibits[0]),i.delete_story_set(e);break}m.push(void 0)}return m}console.log(e._id),d=e.stories,_=[];for(u in d)o=d[u],_.push(function(){var n,r,a;for(a=[],n=0,r=t.length;r>n;n++)s=t[n],s===u?(e.selected=!1,o=e.stories[u],o.status="draft",o.name="",o.short_description="",o.long_description="",o.quiz.question="",o.quiz.comment="",o.quiz.status="",o.quiz.answers||(o.quiz.answers=[]),o.quiz.answers[0].content="",o.quiz.answers[0].correct=!0,o.quiz.answers[1].content="",o.quiz.answers[1].correct=!1,o.quiz.answers[2].content="",o.quiz.answers[2].correct=!1,o.quiz.answers[3].content="",o.quiz.answers[3].correct=!1,a.push(i.update_story(o))):a.push(void 0);return a}());return _},i.dummy_modal_open=function(){var e;return e=a.open({templateUrl:"myDummyModalContent.html",controller:ModalDummyInstanceCtrl,resolve:{modal_options:function(){return{exhibit:i.active_exhibit}}}}),e.result.then(function(e){return i.new_item_creation=!1,i.item_deletion=!0,"save_as"===e?(i.new_exhibit.stories[i.current_museum.language].name="item_"+i.new_exhibit.number,i.new_exhibit.stories[i.current_museum.language].publish_state="passcode",i.new_exhibit.active=!1,i.exhibits.push(i.new_exhibit)):(i.closeDropDown(),i.new_exhibit.active=!1,i.active_exhibit=i.exhibits[0]),i.item_deletion=!1},function(){return console.log("Modal dismissed at: "+new Date)})},i.show_museum_edit=function(e){var t,n;return t=$(e.target),n||(n=!0,$(".navigation .museum_edit").slideToggle(1e3,"easeOutQuint"),i.museum_edit_dropdown_opened=!i.museum_edit_dropdown_opened),!1},i.museum_edit_dropdown_close=function(){var e;return e={target:$(".museum_edit_opener")},i.museum_edit_dropdown_opened?i.show_museum_edit(e):void 0},i.update_story=function(e){return s.put(""+i.backend_url+"/story/"+e._id,e).success(function(){return s.put(""+i.backend_url+"/quiz/"+e.quiz._id,e.quiz).success(function(){var t,n,r,s,u;for(s=e.quiz.answers,u=[],n=0,r=s.length;r>n;n++)t=s[n],u.push(i.put_answers(t));return u}).error(function(){return _.addError(p("Failed to update a quiz for story"))})}).error(function(){return _.addError(p("Failed update a story"))})},i.put_answers=function(e){return s.put(""+i.backend_url+"/quiz_answer/"+e._id,e).success(function(){return console.log("done")}).error(function(){return _.addError(p("Failed to save quiz answer"))})},i.post_stories=function(e,t,n){var r;return null==t&&(t="common"),r="common"===t?e:angular.copy(e),s.post(""+i.backend_url+"/story/",r).success(function(e){return r._id=e._id,r.quiz.story=e._id,null!=n&&n(e),s.post(""+i.backend_url+"/quiz/",r.quiz).success(function(e){var t,n,s,u,o;for(r.quiz._id=e.id,u=r.quiz.answers,o=[],n=0,s=u.length;s>n;n++)t=u[n],t.quiz=e._id,o.push(i.post_answers(t));return o}).error(function(){return _.addError(p("Failed to save quiz for new story"))})}).error(function(){return _.addError(p("Failed to save new story"))})},i.post_answers=function(e){return s.post(""+i.backend_url+"/quiz_answer/",e).success(function(t){return e._id=t._id}).error(function(){return _.addError(p("Failed to save quiz answer"))})},i.mass_switch_pub=function(e){var t,n,r,s,u,o;for(u=i.exhibits,o=[],r=0,s=u.length;s>r;r++)t=u[r],t.selected===!0&&"dummy"!==t.stories[i.current_museum.language].status?(n={},n.item=t.stories[i.current_museum.language],n.root=t,n.field_type="story",n.item.status=e,o.push(m.checkValidity(n))):o.push(void 0);return o},i.delete_selected_exhibits=function(){var e;return i.modal_options={current_language:{name:i.translations[i.current_museum.language],language:i.current_museum.language},languages:i.modal_translations,exhibits:i.exhibits,deletion_password:"123456"},e=a.open({templateUrl:"myModalContent.html",controller:ModalDeleteInstanceCtrl,resolve:{modal_options:function(){return i.modal_options}}}),e.result.then(function(e){var t,n,r,s,u;for(console.log(e.ids_to_delete),s=e.ids_to_delete,u=[],n=0,r=s.length;r>n;n++)t=s[n],t.selected===!0?(t.selected=!1,u.push(i.delete_exhibit(t,e.selected))):u.push(void 0);return u},function(){return console.log("Modal dismissed at: "+new Date)})},i.delete_story=function(e,t,n){return s["delete"](""+i.backend_url+"/story/"+e[t]._id).success(function(r){return console.log(r),null!=n?n(e,t):void 0}).error(function(){return _.addError(p("Failed to delete story in languane: ")+i.translations[t])})},i.delete_story_set=function(e){return s["delete"](""+i.backend_url+"/story_set/"+e._id+"/").success(function(e){return console.log(e)}).error(function(){return _.addError(p("Failed to delete exhibit with number ")+e.number)})},i.group_exhibits_processor=function(e){var t,n,r,s;if(null==e&&(e=!1),i.closeDropDown(),e||null!=i.grouped_exhibits)return i.grouped_exhibits=void 0,setTimeout(function(){return i.grid()},100);for(i.exhibits_visibility_filter="",i.grouped_exhibits={published:[],"private":[],invisible:[],draft:[]},s=i.exhibits,n=0,r=s.length;r>n;n++)switch(t=s[n],t.stories[i.current_museum.language].status){case"published":i.grouped_exhibits.published.push(t);break;case"passcode":i.grouped_exhibits["private"].push(t);break;case"opas_invisible":i.grouped_exhibits.invisible.push(t);break;default:i.grouped_exhibits.draft.push(t)}return i.grid()},i.$watch("current_museum.language",function(e){var t,n,u,o;if(console.log(e),r.lang=e,e){if("dummy"===e)return i.modal_options.current_language={name:i.translations[i.current_museum.language],language:i.current_museum.language},i.create_new_language=!1;if(i.current_museum._id&&s.put(""+i.backend_url+"/story_set/"+i.current_museum._id,i.current_museum).success(function(e){return console.log(e),i.last_save_time=new Date}).error(function(){return _.addError(p("Failed to save museum language"))}),null!=i.grouped_exhibits){for(i.grouped_exhibits={published:[],"private":[],invisible:[],draft:[]},o=i.exhibits,n=0,u=o.length;u>n;n++)switch(t=o[n],t.stories[i.current_museum.language].status){case"published":i.grouped_exhibits.published.push(t);break;case"passcode":i.grouped_exhibits["private"].push(t);break;case"opas_invisible":i.grouped_exhibits.invisible.push(t);break;case"draft":i.grouped_exhibits.draft.push(t)}return i.grid()}}}),i.$watch("exhibits",function(){var e,t,n,r;if(null!=i.grouped_exhibits){for(i.grouped_exhibits={published:[],"private":[],invisible:[],draft:[]},r=i.exhibits,t=0,n=r.length;n>t;t++)switch(e=r[t],e.stories[i.current_museum.language].status){case"published":i.grouped_exhibits.published.push(e);break;case"passcode":i.grouped_exhibits["private"].push(e);break;case"opas_invisible":i.grouped_exhibits.invisible.push(e);break;case"draft":i.grouped_exhibits.draft.push(e)}return i.grid()}},!0),i.$on("save_new_exhibit",function(){return console.log("saving!"),i.new_exhibit.stories[i.current_museum.language].status="passcode",s.post(""+i.backend_url+"/story_set/",i.new_exhibit).success(function(e){var t,n,r;i.exhibits.push(i.new_exhibit),i.new_exhibit._id=e._id,i.last_save_time=new Date,r=i.new_exhibit.stories;for(t in r)n=r[t],n.publish_state="passcode",n.story_set=e._id,i.post_stories(n);return f.find(".item_publish_settings").show()}).error(function(){return _.addError(p("Failed to save new exhibit"))}),i.new_item_creation=!1,i.$digest()}),i.$on("changes_to_save",function(e,t){return t.item._id?(s.put(""+i.backend_url+"/"+t.field_type+"/"+t.item._id,t.item).success(function(e){return t.satus="done",i.last_save_time=new Date,console.log(e)}).error(function(){return _.addError(p("Server error - Prototype error."))}),i.forbid_switch=!1):void 0}),i.$on("quiz_changes_to_save",function(e,t,n){var r,u,o,a,l;for(l=t.collection,o=0,a=l.length;a>o;o++)u=l[o],r=u._id===n._id?!0:!1,u.correct=r,u.correct_saved=r,s.put(""+i.backend_url+"/"+t.field_type+"/"+u._id,u).success(function(e){return console.log(e),i.last_save_time=new Date}).error(function(){return _.addError(p("Failed to update quiz"))});return i.forbid_switch=!1}),i.$watch("exhibits_visibility_filter",function(e,t){return null!=e&&e!==t?(""!==e&&i.group_exhibits_processor(!0),i.closeDropDown()):void 0}),i.$watch("grouped_positions",function(e){return null!=e?localStorage.setItem("grouped_positions",JSON.stringify(i.grouped_positions)):void 0},!0),i.$watch("grouped_exhibits",function(e){return null!=e?localStorage.setItem("grouped","true"):localStorage.setItem("grouped","false")}),i.$watch("exhibit_search",function(e,t){return null!=e&&e!==t?i.closeDropDown():void 0}),i.$watch("current_museum.invalid",function(e){return console.log(null!=e,e),null!=e&&e&&setTimeout(function(){return i.museum_edit_dropdown_opened?void 0:$(".museum_edit_opener").click()},10),!0}),k=localStorage.getItem("grouped_positions"),k&&(i.grouped_positions=JSON.parse(k)),k=localStorage.getItem("grouped"),"true"===k?i.group_exhibits_processor():void 0}]).controller("MuseumEditController",["$scope","$http","$filter","$window","$modal","storage",function(e){return setTimeout(function(){return e.$parent.museumQuizform=e.museumQuizform,e=e.$parent},100),e.$watch("current_museum.stories[current_museum.language].quiz",function(t){if("limited"===t.state){if(!$("#museum_story_quiz_disabled").is(":checked"))return setTimeout(function(){return $("#museum_story_quiz_disabled").click()},10)}else if("published"===t.state)return $("#museum_story_quiz_enabled").is(":checked")?setTimeout(function(){return e.museumQuizform.$valid?void 0:setTimeout(function(){return $("#museum_story_quiz_disabled").click()},10)},100):setTimeout(function(){return $("#museum_story_quiz_enabled").click()},10)},!0),e.$watch("current_museum.stories[current_museum.language].quiz.question",function(){return null!=e.museumQuizform?e.museumQuizform.$valid?e.mark_quiz_validity(e.museumQuizform.$valid):setTimeout(function(){return $("#museum_story_quiz_disabled").click(),e.mark_quiz_validity(e.museumQuizform.$valid)},10):void 0}),e.$watch(function(){return angular.toJson(e.current_museum.stories[e.current_museum.language].quiz.answers)},function(){return null!=e.museumQuizform?e.museumQuizform.$valid?e.mark_quiz_validity(e.museumQuizform.$valid):setTimeout(function(){return $("#museum_story_quiz_disabled").click()},10):void 0},!0),!0}]),this.ModalDeleteInstanceCtrl=function(e,t,n){return e.modal_options=n,e.deletion_password="",console.log(e.modal_options.languages),e.only_one=1===Object.keys(e.modal_options.languages).length,e.password_input_shown=!1,e.ok=function(){var r,i,s,u,o,a,l,c;e.selected=[],e.ids_to_delete=[],l=e.modal_options.languages;for(i in l)u=l[i],u.checked===!0&&e.selected.push(i);for(c=n.exhibits,o=0,a=c.length;a>o;o++)r=c[o],r.selected===!0&&e.ids_to_delete.push(r);return s={ids_to_delete:e.ids_to_delete,selected:e.selected},e.ids_to_delete.length<=1?t.close(s):(e.password_input_shown=!0,e.deletion_password===n.deletion_password?t.close(s):void 0)},e.cancel=function(){return t.dismiss()},e.mark_all=function(){var t,n,r,i;r=e.modal_options.languages,i=[];for(t in r)n=r[t],i.push(n.checked=!0);return i},e.mark_default_only=function(){var t,n,r,i;r=e.modal_options.languages,i=[];for(t in r)n=r[t],n.checked=!1,e.modal_options.current_language.language===t?i.push(n.checked=!0):i.push(void 0);return i},e.mark_default_only()},this.museumDeleteCtrl=function(e,t,n){return e.modal_options=n,e.deletion_password="",e.variant={checked:"lang"},e.ok=function(){return e.deletion_password===n.deletion_password?t.close(e.variant.checked):void 0},e.cancel=function(){return t.dismiss()}},this.ModalDummyInstanceCtrl=function(e,t,n){return e.exhibit=n.exhibit,e.discard=function(){return t.close("discard")},e.save_as=function(){return t.close("save_as")}},this.ModalMuseumInstanceCtrl=function(e,t,n){return e.museum=n.museum,e.translations=n.translations,e.discard=function(){return t.close("discard")},e.save_as=function(){return t.close("save",e.museum)}}}).call(this);